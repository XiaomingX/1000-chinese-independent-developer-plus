## OpenAPI Webhooks 详解：让你的 API 主动通知用户

在 API 开发中，通常是用户主动调用你的 API 获取数据或执行操作。但有些场景下，你需要**你的 API 主动通知用户的应用**，比如发生特定事件时。这种机制就叫做 **Webhook**。

**Webhook 的本质：你的 API 主动 "callback" 用户**

你可以把 Webhook 理解为一种反向 API 调用。不再是用户请求你的 API，而是你的 API 主动请求用户的 API。

**Webhook 的工作流程：**

1.  **定义事件**：你需要在代码中定义哪些事件会触发 Webhook，以及发送的数据格式（Payload）。
2.  **配置 URL**：你的用户需要提供一个 URL，你的 API 会将事件数据 POST 到这个 URL。这个 URL 通常是在你的管理后台配置。
3.  **触发事件**：当定义的事件发生时，你的 API 将构造请求，并将数据发送到用户配置的 URL。
4.  **用户处理**：用户的应用接收到请求，根据数据进行相应的处理。

**用 FastAPI + OpenAPI 定义 Webhook**

FastAPI 结合 OpenAPI 可以方便地定义 Webhook，让用户更容易理解和使用你的 Webhook。

**优势：**

*   **文档化**：OpenAPI 会自动生成 Webhook 的文档，包括事件名称、数据格式等。
*   **标准化**：用户可以根据 OpenAPI 文档，自动生成接收 Webhook 的代码。

**代码示例：**

```python
from datetime import datetime
from fastapi import FastAPI
from pydantic import BaseModel

app = FastAPI()

# 定义数据模型
class Subscription(BaseModel):
    username: str
    monthly_fee: float
    start_date: datetime

# 定义 Webhook
@app.webhooks.post("new-subscription")
def new_subscription(body: Subscription):
    """
    当新用户订阅时，我们会向你注册的 URL 发送 POST 请求，包含订阅信息。
    """
    # 这里不需要实现发送请求的逻辑
    # 只需要定义 Webhook 的名称和数据格式
    pass

@app.get("/users/")
def read_users():
    return ["Rick", "Morty"]
```

**解释：**

*   `@app.webhooks.post("new-subscription")`：定义了一个名为 "new-subscription" 的 Webhook，使用 POST 方法。注意，这里 `new-subscription` 并不是一个 URL 路径，而是一个事件名称。用户需要在你的管理后台配置接收这个事件的 URL。
*   `Subscription`：定义了 Webhook 发送的数据格式。
*   函数 `new_subscription`： 只是用于定义openapi文档，**不需要**在这里编写实际发送 Webhook 请求的代码。实际发送请求的逻辑，需要在其他地方实现。

**实际应用场景：**

*   **支付成功通知**：当用户支付成功后，你的支付系统可以发送 Webhook 通知用户的应用，用户的应用可以更新订单状态。
*   **新用户注册通知**：当有新用户注册时，你的用户系统可以发送 Webhook 通知用户的应用，用户的应用可以发送欢迎邮件。
*   **商品库存变更通知**：当商品库存发生变化时，你的电商平台可以发送 Webhook 通知用户的应用，用户的应用可以及时更新商品信息。

**案例 1：支付成功 Webhook**

1.  **事件名称**："payment-success"
2.  **数据格式**：

```json
{
  "order_id": "123456",
  "payment_amount": 100.00,
  "payment_time": "2023-10-27 10:00:00",
  "user_id": "user123"
}
```

3.  **用户配置**：用户在你的支付平台配置接收 "payment-success" 事件的 URL：`https://user.example.com/payment-callback`
4.  **触发**：用户支付成功后，你的支付平台向 `https://user.example.com/payment-callback` 发送 POST 请求，包含上述 JSON 数据。
5.  **用户处理**：用户的应用接收到请求，根据 `order_id` 更新订单状态为 "已支付"。

**案例 2：GitHub 的 Webhook**

GitHub 提供了丰富的 Webhook 事件，例如：

*   `push`：当有代码被 push 到仓库时触发。
*   `pull_request`：当有新的 Pull Request 被创建、更新或关闭时触发。
*   `issue`：当有新的 Issue 被创建、更新或关闭时触发。

用户可以在 GitHub 仓库的 "Settings" -> "Webhooks" 中配置 Webhook。

**重要提示：**

*   **安全性**：确保 Webhook 的安全性，例如使用 HTTPS，验证请求来源，避免恶意攻击。
*   **重试机制**：如果 Webhook 发送失败，需要有重试机制，确保事件能够最终送达。
*   **错误处理**：用户的应用可能会返回错误，你的 API 需要处理这些错误，例如记录日志，通知管理员。

**总结：**

Webhook 是一种强大的 API 扩展机制，可以让你的 API 更加灵活和智能。通过 FastAPI 和 OpenAPI，你可以方便地定义和文档化 Webhook，让用户更容易集成你的 API。