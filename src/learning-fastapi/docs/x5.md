## FastAPI 后台任务 (Background Tasks) 详解与应用

FastAPI 的后台任务功能，允许你在 API 响应返回后，继续执行一些耗时操作。这对于提升 API 响应速度和用户体验至关重要。你可以理解为，当用户访问你的 API 时，服务器快速返回一个“已收到”的消息，然后默默地在后台处理一些比较慢的事情，比如发邮件、处理上传的文件等。

**核心概念：**

*   **`BackgroundTasks`**: FastAPI 提供的类，用于管理后台任务。
*   **任务函数**: 你要执行的后台操作，可以是普通函数 (`def`) 或异步函数 (`async def`)。

**适用场景：**

*   **发送邮件通知**：用户注册、订单确认后，发送邮件通知。
*   **数据处理**：上传文件后，进行数据清洗、转换、存储。
*   **日志记录**：记录 API 请求信息，用于分析和调试。
*   **生成报表**：定时生成统计报表。

**优势：**

*   **提升响应速度**：避免因耗时操作阻塞 API 响应。
*   **改善用户体验**：用户无需等待后台任务完成即可获得反馈。
*   **简化代码**：无需手动创建线程或进程来处理后台任务。

**如何使用 `BackgroundTasks`：**

1.  **导入 `BackgroundTasks`**:

    ```python
    from fastapi import BackgroundTasks, FastAPI
    ```
2.  **创建 FastAPI 应用**:

    ```python
    app = FastAPI()
    ```
3.  **定义任务函数**:
    任务函数可以是同步或异步的。

    ```python
    def write_log(message: str):
        with open("log.txt", mode="a") as log:
            log.write(message)
    ```
4.  **在 API 接口中使用 `BackgroundTasks`**:
    在你的 API 接口函数中，添加一个 `BackgroundTasks` 类型的参数。FastAPI 会自动为你注入这个对象。使用 `background_tasks.add_task()` 方法来添加后台任务。

    ```python
    from fastapi import BackgroundTasks, FastAPI

    app = FastAPI()

    def write_log(message: str):
        with open("log.txt", mode="a") as log:
            log.write(message)

    @app.post("/send-notification/{email}")
    async def send_notification(email: str, background_tasks: BackgroundTasks):
        background_tasks.add_task(write_log, f"Sending notification to {email}")
        return {"message": "Notification sent in the background"}
    ```

**实际应用例子：**

**例子 1：发送邮件通知**

假设用户注册成功后，我们需要发送一封欢迎邮件。

```python
from fastapi import BackgroundTasks, FastAPI
from pydantic import BaseModel
import smtplib
from email.mime.text import MIMEText

app = FastAPI()

class User(BaseModel):
    email: str
    username: str

def send_email(email: str, username: str):
    sender_email = "your_email@example.com"
    sender_password = "your_password"
    receiver_email = email

    message = MIMEText(f"欢迎 {username} 注册!")
    message["Subject"] = "欢迎注册"
    message["From"] = sender_email
    message["To"] = receiver_email

    try:
        with smtplib.SMTP_SSL("smtp.example.com", 465) as server:
            server.login(sender_email, sender_password)
            server.sendmail(sender_email, receiver_email, message.as_string())
    except Exception as e:
        print(f"邮件发送失败: {e}")

@app.post("/register")
async def register_user(user: User, background_tasks: BackgroundTasks):
    # 模拟用户注册
    print(f"用户 {user.username} 注册成功")
    background_tasks.add_task(send_email, user.email, user.username)
    return {"message": "注册成功，欢迎邮件将在后台发送"}
```

**解释：**

*   `send_email` 函数负责发送邮件，这里使用了 `smtplib` 库。
*   `/register` 接口模拟用户注册，然后使用 `background_tasks.add_task()` 将 `send_email` 函数添加到后台任务队列。

**例子 2：处理上传的文件**

假设用户上传了一个很大的 CSV 文件，我们需要在后台对其进行处理。

```python
from fastapi import BackgroundTasks, FastAPI, File, UploadFile
import pandas as pd

app = FastAPI()

def process_csv(file_path: str):
    try:
        df = pd.read_csv(file_path)
        # 在这里进行你的数据处理逻辑
        print(f"文件处理完毕，共有 {len(df)} 行数据")
    except Exception as e:
        print(f"文件处理失败: {e}")

@app.post("/upload")
async def upload_file(file: UploadFile = File(...), background_tasks: BackgroundTasks = BackgroundTasks()):
    file_path = f"{file.filename}"
    try:
        contents = await file.read()
        with open(file_path, "wb") as f:
            f.write(contents)
    except Exception:
        return {"message": "There was an error uploading the file"}
    finally:
        await file.close()

    background_tasks.add_task(process_csv, file_path)
    return {"filename": file.filename, "message": "文件上传成功，将在后台处理"}
```

**解释：**

*   `process_csv` 函数负责处理 CSV 文件，这里使用了 `pandas` 库。
*   `/upload` 接口接收用户上传的文件，然后使用 `background_tasks.add_task()` 将 `process_csv` 函数添加到后台任务队列。

**注意事项：**

*   **错误处理**：后台任务中的错误不会直接影响 API 响应，因此需要在任务函数中进行适当的错误处理，例如记录日志、发送警报等。
*   **资源消耗**：后台任务会消耗服务器资源，需要根据实际情况控制任务数量和复杂度，避免资源耗尽。
*   **任务调度**：对于更复杂的任务调度需求，可以考虑使用 Celery 等专业的任务队列系统。

**总结：**

FastAPI 的 `BackgroundTasks` 提供了一种简单有效的方式来处理后台任务，可以显著提升 API 的性能和用户体验。通过合理地使用后台任务，你可以构建更加高效、可靠的 Web 应用程序。