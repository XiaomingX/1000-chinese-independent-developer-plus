## 基于 OpenAPI 自动生成客户端

FastAPI 基于 OpenAPI 规范，因此可以自动与许多工具兼容，包括 Swagger UI 提供的自动 API 文档。

**技术知识点：**

*   **OpenAPI:** 一种用于描述 API 接口的标准格式，它能让机器和人都能理解 API 的功能，而无需访问源码、额外文档或网络流量检测.
*   **Swagger UI:** 一种流行的 OpenAPI 文档展示工具，可以根据 OpenAPI 规范动态生成美观的 API 文档，方便开发者测试和使用 API.

**优势：**

*   **自动生成客户端 (SDK):**  可以根据 OpenAPI 规范，为多种编程语言自动生成客户端代码，简化了前端或移动端调用后端 API 的过程。

### OpenAPI 客户端生成器

有许多工具可以从 OpenAPI 生成客户端。

*   **OpenAPI Generator:** 一款常用的开源工具，支持生成多种语言的客户端代码。
*   **openapi-ts:**  特别适用于前端项目，可以生成 TypeScript 客户端代码。
*   **商业公司提供的生成器：** Speakeasy, Stainless, liblab 等，它们通常提供额外的功能和更高质量的 SDK。

### 生成 TypeScript 前端客户端示例

以下示例展示如何基于 FastAPI 应用生成 TypeScript 客户端代码。

**1. FastAPI 后端代码 (Python):**

```python
from fastapi import FastAPI
from pydantic import BaseModel

app = FastAPI()

class Item(BaseModel):
    name: str
    price: float

class ResponseMessage(BaseModel):
    message: str

@app.post("/items/", response_model=ResponseMessage)
async def create_item(item: Item):
    return {"message": "item received"}

@app.get("/items/", response_model=list[Item])
async def get_items():
    return [
        {"name": "Plumbus", "price": 3},
        {"name": "Portal Gun", "price": 9001},
    ]
```

**代码解释：**

*   定义了两个数据模型 `Item` 和 `ResponseMessage`，使用 Pydantic 库进行数据验证和序列化。
*   创建了两个 API 接口：
    *   `POST /items/`:  接收 `Item` 对象，返回 `ResponseMessage`。
    *   `GET /items/`:  返回 `Item` 对象列表。
*   `response_model` 参数指定了 API 接口的响应数据模型。

**2. 安装 openapi-ts (JavaScript/TypeScript):**

在你的前端项目中，使用 npm 安装 openapi-ts:

```bash
npm install @hey-api/openapi-ts --save-dev
```

**3. 生成客户端代码 (JavaScript/TypeScript):**

在 `package.json` 文件中添加一个 script 命令，用于生成客户端代码:

```json
{
  "name": "frontend-app",
  "version": "1.0.0",
  "scripts": {
    "generate-client": "openapi-ts --input http://localhost:8000/openapi.json --output ./src/client --client axios"
  },
  "devDependencies": {
    "@hey-api/openapi-ts": "^0.27.38",
    "typescript": "^4.6.2"
  }
}
```

然后运行该命令：

```bash
npm run generate-client
```

**命令解释：**

*   `--input http://localhost:8000/openapi.json`:  指定 OpenAPI 规范的 URL，FastAPI 默认在 `/openapi.json` 提供该文件。
*   `--output ./src/client`:  指定生成代码的输出目录。
*   `--client axios`:  指定使用 axios 作为 HTTP 客户端库。

**4. 使用客户端代码 (JavaScript/TypeScript):**

在你的前端代码中，导入生成的客户端代码并使用它:

```typescript
import { ItemsService } from "./client";

async function getItems() {
  const items = await ItemsService.getItemsItemsGet();
  console.log(items);
}

getItems();
```

**代码解释：**

*   `ItemsService` 包含了与 `/items/` 相关的 API 接口。
*   `getItemsItemsGet()` 方法对应于 `GET /items/` 接口。

### 使用 Tags 组织 API

当 FastAPI 应用较大时，可以使用 tags 将不同的 API 接口分组。

**示例 (Python):**

```python
from fastapi import FastAPI
from pydantic import BaseModel

app = FastAPI()

class Item(BaseModel):
    name: str
    price: float

class ResponseMessage(BaseModel):
    message: str

class User(BaseModel):
    username: str
    email: str

@app.post("/items/", response_model=ResponseMessage, tags=["items"])
async def create_item(item: Item):
    return {"message": "Item received"}

@app.get("/items/", response_model=list[Item], tags=["items"])
async def get_items():
    return [
        {"name": "Plumbus", "price": 3},
        {"name": "Portal Gun", "price": 9001},
    ]

@app.post("/users/", response_model=ResponseMessage, tags=["users"])
async def create_user(user: User):
    return {"message": "User received"}
```

**代码解释：**

*   使用 `tags` 参数将 API 接口分为 `items` 和 `users` 两组。
*   生成客户端代码时，会根据 tags 将代码分成不同的模块，例如 `ItemsService` 和 `UsersService`。

### 自定义 Operation ID

FastAPI 默认根据函数名、路径和 HTTP 方法生成 Operation ID，可以通过自定义 `generate_unique_id_function` 参数来修改生成规则，从而简化客户端代码中的方法名。

**示例 (Python):**

```python
from fastapi import FastAPI
from fastapi.routing import APIRoute
from pydantic import BaseModel

def custom_generate_unique_id(route: APIRoute):
    return f"{route.tags[0]}-{route.name}"

app = FastAPI(generate_unique_id_function=custom_generate_unique_id)

class Item(BaseModel):
    name: str
    price: float

class ResponseMessage(BaseModel):
    message: str

class User(BaseModel):
    username: str
    email: str

@app.post("/items/", response_model=ResponseMessage, tags=["items"])
async def create_item(item: Item):
    return {"message": "Item received"}

@app.get("/items/", response_model=list[Item], tags=["items"])
async def get_items():
    return [
        {"name": "Plumbus", "price": 3},
        {"name": "Portal Gun", "price": 9001},
    ]

@app.post("/users/", response_model=ResponseMessage, tags=["users"])
async def create_user(user: User):
    return {"message": "User received"}
```

**代码解释：**

*   `custom_generate_unique_id` 函数使用 tag 和函数名生成 Operation ID。
*   将该函数作为 `generate_unique_id_function` 参数传递给 `FastAPI` 实例。

### 预处理 OpenAPI 规范

在生成客户端代码之前，可以先对 OpenAPI 规范进行预处理，例如移除 Operation ID 中的 tag 前缀，以获得更简洁的方法名。

**示例 (Python):**

```python
import json
from pathlib import Path

file_path = Path("./openapi.json")
openapi_content = json.loads(file_path.read_text())

for path_data in openapi_content["paths"].values():
    for operation in path_data.values():
        tag = operation["tags"][0]
        operation_id = operation["operationId"]
        to_remove = f"{tag}-"
        new_operation_id = operation_id[len(to_remove) :]
        operation["operationId"] = new_operation_id

file_path.write_text(json.dumps(openapi_content))
```

**代码解释：**

*   读取 `openapi.json` 文件，解析为 JSON 对象。
*   遍历所有 API 接口，移除 Operation ID 中的 tag 前缀。
*   将修改后的 JSON 对象写回 `openapi.json` 文件。

### 自动生成客户端的优势

*   **代码自动补全：**  在开发过程中，IDE 可以根据 OpenAPI 规范提供方法名、请求参数和响应数据的自动补全功能，提高开发效率。
*   **内联错误提示：**  如果代码中使用了不正确的数据类型或参数，IDE 会立即给出错误提示，避免运行时错误。
*   **及时同步：**  当后端 API 接口发生变化时，只需重新生成客户端代码，即可自动同步最新的接口定义，减少维护成本。
*   **提前发现错误：** 在开发周期中更早地检测到许多错误，而不是等到错误出现在生产中的最终用户面前，然后再尝试调试问题。

**总结：**

通过 OpenAPI 自动生成客户端代码，可以极大地提高 API 开发效率和代码质量，降低维护成本。 开发者可以根据实际需求选择合适的客户端生成工具和自定义配置，以获得最佳的开发体验。