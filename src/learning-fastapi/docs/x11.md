## FastAPI 高级中间件：像搭积木一样扩展你的应用

FastAPI 基于 Starlette 和 ASGI 标准，你可以像搭积木一样，通过中间件来扩展应用的功能。中间件就像是请求和响应之间的“关卡”，可以对它们进行处理。

### 什么是中间件？

可以把中间件想象成一个函数，它接收每个进来的请求，并在将请求传递给你的应用代码之前或之后执行一些操作。这可以用于多种用途，例如：

*   **安全：** 验证用户身份，防止恶意攻击。
*   **日志：** 记录请求信息，方便调试和监控。
*   **性能：** 压缩响应数据，提高传输速度。
*   **修改请求或响应：** 在请求到达你的应用之前或响应发送给客户端之前修改它们。

### 如何添加中间件

FastAPI 提供了 `app.add_middleware()` 方法来添加中间件。

```python
from fastapi import FastAPI

app = FastAPI()

# 添加一个自定义中间件
@app.middleware("http")
async def add_process_time_header(request, call_next):
    start_time = time.time()
    response = await call_next(request)
    process_time = time.time() - start_time
    response.headers["X-Process-Time"] = str(process_time)
    return response
```

*   `app.add_middleware()` 接收中间件类作为第一个参数，以及传递给中间件的任何其他参数。
*   通过装饰器`@app.middleware("http")`来定义中间件，指定它处理HTTP请求。

### FastAPI 集成的常用中间件

FastAPI 提供了一些常用的中间件，可以直接使用：

*   **`HTTPSRedirectMiddleware`：** 强制所有请求使用 HTTPS。如果收到 HTTP 请求，会自动重定向到 HTTPS。
*   **`TrustedHostMiddleware`：** 验证请求的 Host header，防止 HTTP Host Header 攻击。
*   **`GZipMiddleware`：** 压缩响应数据，减少传输大小，提高性能。

#### `HTTPSRedirectMiddleware`

确保所有进入的请求都是 `https` 或者 `wss` 协议。任何 `http` 或 `ws` 的请求都会被重定向到安全的协议。

```python
from fastapi import FastAPI
from fastapi.middleware.httpsredirect import HTTPSRedirectMiddleware

app = FastAPI()

app.add_middleware(HTTPSRedirectMiddleware)

@app.get("/")
async def main():
    return {"message": "Hello World"}
```

#### `TrustedHostMiddleware`

确保所有进入的请求都有正确的 Host header，防止 HTTP Host Header 攻击。

```python
from fastapi import FastAPI
from fastapi.middleware.trustedhost import TrustedHostMiddleware

app = FastAPI()

app.add_middleware(
    TrustedHostMiddleware, allowed_hosts=["example.com", "*.example.com"]
)

@app.get("/")
async def main():
    return {"message": "Hello World"}
```

这个中间件支持以下参数：

*   `allowed_hosts`: 允许的主机名列表。可以使用通配符，例如 `*.example.com` 匹配所有子域名。如果请求的 Host header 不在允许列表中，会返回 400 错误。

#### `GZipMiddleware`

对于包含 "gzip" 在 `Accept-Encoding` header 中的任何请求，这个中间件会处理 GZip 压缩响应。

```python
from fastapi import FastAPI
from fastapi.middleware.gzip import GZipMiddleware

app = FastAPI()

app.add_middleware(GZipMiddleware, minimum_size=1000, compresslevel=5)

@app.get("/")
async def main():
    return "somebigcontent"
```

这个中间件支持以下参数：

*   `minimum_size`:  最小压缩大小，单位是字节。小于这个大小的响应不会被压缩。默认值是 500。
*   `compresslevel`: 压缩级别，范围是 1 到 9。值越小，压缩速度越快，但文件越大；值越大，压缩速度越慢，但文件越小。默认值是 9。

### 实际应用例子

1.  **性能监控中间件：** 记录每个请求的处理时间，用于性能分析。

    ```python
    import time
    from fastapi import FastAPI, Request

    app = FastAPI()

    @app.middleware("http")
    async def process_time_middleware(request: Request, call_next):
        start_time = time.time()
        response = await call_next(request)
        process_time = time.time() - start_time
        response.headers["X-Process-Time"] = str(process_time)
        print(f"Request {request.url} took {process_time:.4f} seconds") # 增加日志输出
        return response
    ```

2.  **CORS 中间件：** 处理跨域请求，允许来自特定域名的请求。

    ```python
    from fastapi import FastAPI
    from fastapi.middleware.cors import CORSMiddleware

    app = FastAPI()

    origins = [
        "http://localhost",
        "http://localhost:8080",
        "http://127.0.0.1:9000",  # 允许的来源
    ]

    app.add_middleware(
        CORSMiddleware,
        allow_origins=origins,
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    ```

### 更多选择

除了 FastAPI 自带的中间件，还有很多第三方 ASGI 中间件可以使用，例如：

*   Uvicorn 的 `ProxyHeadersMiddleware`：处理反向代理的 headers。
*   `MessagePack`：支持 MessagePack 格式的请求和响应。

### 总结

FastAPI 的中间件机制非常灵活，可以方便地扩展应用的功能。你可以根据自己的需求，选择合适的中间件，或者自定义中间件。 通过中间件，可以以声明式的方式在你的应用程序中添加功能，而无需修改你的视图函数。