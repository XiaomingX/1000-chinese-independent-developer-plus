## FastAPI 大型应用组织方式：模块化和 APIRouter 的妙用

当你的 FastAPI 项目变得庞大时，将所有代码放在一个文件里是不现实的。FastAPI 提供了 `APIRouter`，它可以帮助你更好地组织项目结构，类似于 Flask 中的 Blueprints。

**项目结构示例**

一个典型的项目结构可能如下所示：

```
.
├── app                  # 主应用目录 (Python 包)
│   ├── __init__.py      # 初始化文件，使 "app" 成为 Python 包
│   ├── main.py          # 主模块，例如: import app.main
│   ├── dependencies.py  # 依赖模块，例如: import app.dependencies
│   └── routers          # 路由子包
│   │   ├── __init__.py  # 使 "routers" 成为 Python 子包
│   │   ├── items.py     # "items" 子模块，例如: import app.routers.items
│   │   └── users.py     # "users" 子模块，例如: import app.routers.users
│   └── internal         # 内部子包
│       ├── __init__.py  # 使 "internal" 成为 Python 子包
│       └── admin.py     # "admin" 子模块，例如: import app.internal.admin
```

每个目录下的 `__init__.py` 文件使得 Python 可以将该目录识别为一个包，从而允许你从其他文件中导入代码。例如，在 `app/main.py` 中，你可以这样导入 `app/routers/items.py`：

```python
from app.routers import items
```

**APIRouter 的使用**

`APIRouter` 就像一个“迷你 FastAPI”应用，用于组织一组相关的路由。

1.  **创建 APIRouter 实例**

   在你的路由模块（例如 `app/routers/users.py`）中，首先导入 `APIRouter` 并创建一个实例：

   ```python
   from fastapi import APIRouter

   router = APIRouter()
   ```

2.  **使用 APIRouter 定义路由**

   像使用 `FastAPI` 实例一样，使用 `APIRouter` 实例来定义你的路由：

   ```python
   from fastapi import APIRouter

   router = APIRouter()


   @router.get("/users/", tags=["users"])
   async def read_users():
       return [{"username": "Rick"}, {"username": "Morty"}]


   @router.get("/users/me", tags=["users"])
   async def read_user_me():
       return {"username": "fakecurrentuser"}


   @router.get("/users/{username}", tags=["users"])
   async def read_user(username: str):
       return {"username": username}
   ```

   在这个例子中，所有以 `/users` 开头的路由都被组织在 `users.py` 文件中，并打上了 `users` 标签。

3.  **包含 APIRouter 到主应用**

   在主应用文件（`app/main.py`）中，导入你创建的 `APIRouter` 实例，并使用 `app.include_router()` 将其包含到主应用中：

   ```python
   from fastapi import FastAPI
   from app.routers import users, items

   app = FastAPI()

   app.include_router(users.router)
   app.include_router(items.router)
   ```

**更进一步：添加依赖、标签和前缀**

`APIRouter` 还可以让你为一组路由添加统一的配置：

*   **前缀 (prefix)**：为所有路由添加一个统一的前缀。
*   **标签 (tags)**：为所有路由添加标签，方便在 API 文档中进行分类。
*   **依赖 (dependencies)**：为所有路由添加依赖项，例如身份验证。

**示例：统一配置**

假设 `app/routers/items.py` 中的所有路由都需要一个 `X-Token` 头部进行身份验证，并且都属于 `items` 标签，你可以这样设置 `APIRouter`：

```python
from fastapi import APIRouter, Depends, HTTPException
from fastapi import Header
from typing import Annotated

async def get_token_header(x_token: Annotated[str, Header()]):
    if x_token != "fake-super-secret-token":
        raise HTTPException(status_code=400, detail="X-Token header invalid")
    return x_token

router = APIRouter(
    prefix="/items",
    tags=["items"],
    dependencies=[Depends(get_token_header)],
    responses={404: {"description": "Not found"}},
)


fake_items_db = {"plumbus": {"name": "Plumbus"}, "gun": {"name": "Portal Gun"}}


@router.get("/")
async def read_items():
    return fake_items_db


@router.get("/{item_id}")
async def read_item(item_id: str):
    if item_id not in fake_items_db:
        raise HTTPException(status_code=404, detail="Item not found")
    return {"name": fake_items_db[item_id]["name"], "item_id": item_id}


@router.put(
    "/{item_id}",
    tags=["custom"],
    responses={403: {"description": "Operation forbidden"}},
)
async def update_item(item_id: str):
    if item_id != "plumbus":
        raise HTTPException(
            status_code=403, detail="You can only update the item: plumbus"
        )
    return {"item_id": item_id, "name": "The great Plumbus"}
```

现在，所有 `items` 路由都会自动添加 `/items` 前缀、`items` 标签和 `get_token_header` 依赖。

**实际应用案例：电商 API**

假设你正在构建一个电商 API，你可以使用 `APIRouter` 将不同的功能模块分开：

*   `app/routers/products.py`：处理商品相关的路由（例如 `/products/`, `/products/{product_id}`）。
*   `app/routers/orders.py`：处理订单相关的路由（例如 `/orders/`, `/orders/{order_id}`）。
*   `app/routers/users.py`：处理用户相关的路由（例如 `/users/`, `/users/{user_id}`）。

每个模块都可以有自己的 `APIRouter` 实例，并在主应用中统一包含。这样可以使你的代码结构更清晰、更易于维护。

**Demo 代码 (app/main.py)**

```python
from fastapi import FastAPI

from app.routers import users, items
from app.internal import admin

app = FastAPI()

app.include_router(users.router)
app.include_router(items.router)
app.include_router(
    admin.router,
    prefix="/admin",
    tags=["admin"],
    # dependencies=[Depends(get_token_header)], #假设有get_token_header函数
    responses={418: {"description": "I'm a teapot"}},
)


@app.get("/")
async def root():
    return {"message": "Hello Bigger Applications!"}
```

**总结**

`APIRouter` 是 FastAPI 中组织大型应用的关键工具。通过将相关的路由分组到不同的模块中，并使用 `APIRouter` 进行统一配置，你可以构建出结构清晰、易于维护的 API 应用。它能有效避免代码重复，提升开发效率，并最终改善用户体验。