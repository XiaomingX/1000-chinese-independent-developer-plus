以下是如何使用 FastAPI 框架处理查询参数以及如何进行字符串验证的简单解释，并附带实际应用例子和代码：

## FastAPI 查询参数与字符串验证

在使用 FastAPI 构建 API 时，查询参数是 URL 中 `?` 后面的部分，例如 `http://example.com/items/?name=keyboard&price=100` 中的 `name=keyboard&price=100`。
FastAPI 允许你对这些参数进行验证和添加额外的信息，确保数据的准确性和安全性。

### **基本查询参数**

```python
from fastapi import FastAPI

app = FastAPI()

@app.get("/items/")
async def read_items(name: str = None):
    if name:
        return {"item_name": name}
    return {"message": "No item name provided"}
```

在这个例子中，`name` 是一个可选的查询参数。如果没有提供 `name` 参数，API 将返回 `{"message": "No item name provided"}`。

### **使用 `Query` 进行验证**

`Query` 类允许你对查询参数进行更细致的控制和验证。

```python
from typing import Annotated
from fastapi import FastAPI, Query

app = FastAPI()

@app.get("/items/")
async def read_items(
    name: Annotated[str | None, Query(max_length=50, min_length=3)] = None
):
    if name:
        return {"item_name": name}
    return {"message": "No item name provided"}
```

在这个例子中，`name` 参数使用了 `Query`，并设置了 `max_length=50` 和 `min_length=3`，这意味着 `name` 的最大长度为 50 个字符，最小长度为 3 个字符。如果 `name` 的长度不符合要求，FastAPI 将会自动返回错误信息。

### **实际应用：搜索商品**

假设你要创建一个搜索商品的 API，用户可以通过关键词搜索商品，并可以指定返回结果的数量。

```python
from typing import Annotated
from fastapi import FastAPI, Query

app = FastAPI()

@app.get("/search/")
async def search_items(
    keyword: Annotated[str, Query(min_length=2, description="Keywords for item search")],
    limit: Annotated[int, Query(gt=0, le=50, description="Maximum number of items to return")] = 10
):
    # 模拟数据库查询
    items = [f"Item {i+1} matching '{keyword}'" for i in range(limit)]
    return {"results": items}
```

在这个例子中：

*   `keyword` 是一个必需的查询参数，最小长度为 2 个字符，用于指定搜索关键词。`description` 提供了对参数的描述，这将在 API 文档中显示。
*   `limit` 是一个可选的查询参数，用于限制返回结果的数量，默认为 10。`gt=0` 表示 `limit` 必须大于 0，`le=50` 表示 `limit` 必须小于等于 50。

访问 `http://localhost:8000/search/?keyword=apple&limit=5` 将返回 5 个包含 "apple" 关键词的商品。如果访问 `http://localhost:8000/search/?keyword=a`，由于关键词长度小于 2，FastAPI 将返回错误。

### **正则表达式验证**

你可以使用正则表达式来验证查询参数的格式。

```python
from typing import Annotated
from fastapi import FastAPI, Query

app = FastAPI()

@app.get("/items/")
async def read_items(
    item_id: Annotated[str | None, Query(pattern="^ITEM-[0-9]{3}$")] = None
):
    if item_id:
        return {"item_id": item_id}
    return {"message": "No item ID provided"}
```

在这个例子中，`item_id` 必须符合正则表达式 `^ITEM-[0-9]{3}$`，例如 "ITEM-123"。

### **查询参数列表**

你可以声明一个查询参数可以接收多个值。

```python
from typing import Annotated
from fastapi import FastAPI, Query

app = FastAPI()

@app.get("/items/")
async def read_items(categories: Annotated[list[str] | None, Query()] = None):
    if categories:
        return {"categories": categories}
    return {"message": "No categories provided"}
```

在这个例子中，`categories` 可以接收多个值，例如 `http://localhost:8000/items/?categories=Electronics&categories=Books`。

### **总结**

通过 `Query` 类，你可以轻松地对查询参数进行验证、添加元数据，并控制参数的行为。这有助于提高 API 的健壮性和安全性。

使用 FastAPI 的参数验证功能，你可以确保 API 接收到的数据是符合预期的，从而避免潜在的错误和安全问题。同时，FastAPI 的自动文档生成功能可以根据你定义的验证规则生成清晰的 API 文档，方便开发者使用你的 API。