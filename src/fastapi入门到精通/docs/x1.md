## FastAPI 快速上手指南：用 Python 轻松构建高性能 API

FastAPI 是一个基于 Python 的 Web 框架，它能帮助你快速、高效地构建 API 接口。 它的主要特点是**速度快**、**易于使用**，并且**基于最新的 Python 标准**.

**核心优势：**

*   **高性能：** FastAPI 的性能可以媲美 NodeJS 和 Go，这得益于它底层的 Starlette 和 Pydantic 库.
*   **开发效率高：** 使用 FastAPI 可以显著提升开发速度，测试表明可以提高 200% 到 300%.
*   **Bug 更少：** 统计显示，FastAPI 可以减少大约 40% 的人为错误.
*   **智能提示：** 强大的编辑器支持，处处都有代码补全，减少调试时间。
*   **简单易学：** 学习曲线平缓，文档完善，更容易上手。
*   **代码简洁：** 减少重复代码，通过参数声明实现多种功能。
*   **稳定可靠：** 生成的代码可以直接用于生产环境，自带交互式文档。
*   **遵循标准：** 完全兼容 OpenAPI 和 JSON Schema 等 API 开放标准.

**实际应用：**

很多知名公司都在使用 FastAPI：

*   **微软：** 用于构建 ML 服务，集成到 Windows 和 Office 产品中。
*   **Uber：** 用于搭建 REST 服务，提供预测功能。
*   **Netflix：** 用于危机管理编排框架 Dispatch。
*   **Cisco:** 用于 API 优先的开发策略，并驱动许多自动化和服务。

**安装：**

首先，创建一个虚拟环境，然后使用 pip 安装 FastAPI：

```bash
pip install "fastapi[standard]"
```

**注意：** 务必将 `"fastapi[standard]"` 放在引号内，以确保在所有终端中都能正常工作。

**快速上手示例：**

1.  **创建 `main.py` 文件：**

    ```python
    from typing import Union
    from fastapi import FastAPI

    app = FastAPI()

    @app.get("/")
    def read_root():
        return {"Hello": "World"}

    @app.get("/items/{item_id}")
    def read_item(item_id: int, q: Union[str, None] = None):
        return {"item_id": item_id, "q": q}
    ```
2.  **运行服务器：**

    ```bash
    fastapi dev main.py
    ```

    运行后，你会在终端看到类似下面的信息：

    ```text
    INFO:     Uvicorn running on http://127.0.0.1:8000 (Press CTRL+C to quit)
    ```
3.  **查看效果：**
    *   在浏览器中打开 `http://127.0.0.1:8000/items/5?q=somequery`，你会看到 JSON 格式的响应：

        ```json
        {"item_id": 5, "q": "somequery"}
        ```
    *   访问 `http://127.0.0.1:8000/docs`，可以查看自动生成的交互式 API 文档 (Swagger UI)。

    *   访问 `http://127.0.0.1:8000/redoc`，可以查看另一种风格的 API 文档 (ReDoc)。

**代码解释：**

*   `FastAPI()`: 创建一个 FastAPI 应用实例。
*   `@app.get("/")`:  定义一个 GET 请求的路由，路径为根目录 `/`。
*   `@app.get("/items/{item_id}")`: 定义一个 GET 请求的路由，路径为 `/items/{item_id}`，其中 `{item_id}` 是一个路径参数。
*   `item_id: int`:  声明 `item_id` 的类型为整数 (int)。FastAPI 会自动验证传入的参数是否符合类型要求。
*   `q: Union[str, None] = None`: 声明 `q` 是一个可选的查询参数，类型为字符串 (str) 或 None。`= None` 表示该参数是可选的。
*   `Union[str, None]`: 表示 `q` 可以是字符串或 None，等效于 `Optional[str]`。

**升级示例：接收 PUT 请求和请求体**

修改 `main.py` 文件，添加接收 PUT 请求的功能，并使用 Pydantic 定义请求体的数据结构：

```python
from typing import Union

from fastapi import FastAPI
from pydantic import BaseModel

app = FastAPI()

class Item(BaseModel):
    name: str
    price: float
    is_offer: Union[bool, None] = None

@app.get("/")
def read_root():
    return {"Hello": "World"}

@app.get("/items/{item_id}")
def read_item(item_id: int, q: Union[str, None] = None):
    return {"item_id": item_id, "q": q}

@app.put("/items/{item_id}")
def update_item(item_id: int, item: Item):
    return {"item_name": item.name, "item_id": item_id}
```

**代码解释：**

*   `class Item(BaseModel)`:  定义一个名为 `Item` 的 Pydantic 模型，用于描述请求体的数据结构。
    *   `name: str`:  `name` 属性，类型为字符串。
    *   `price: float`: `price` 属性，类型为浮点数。
    *   `is_offer: Union[bool, None] = None`: `is_offer` 属性，类型为布尔值 (bool) 或 None，默认值为 None (可选)。
*   `@app.put("/items/{item_id}")`:  定义一个 PUT 请求的路由。
*   `item: Item`: 声明 `item` 参数的类型为 `Item` 模型。FastAPI 会自动将请求体中的 JSON 数据解析为 `Item` 对象的实例，并进行数据验证。

**实际应用 Demo：**

假设我们要创建一个 API，用于管理商品信息。

1.  **定义商品模型：**

    ```python
    from typing import Union
    from fastapi import FastAPI
    from pydantic import BaseModel

    app = FastAPI()

    class Product(BaseModel):
        id: int
        name: str
        description: Union[str, None] = None
        price: float
        is_active: bool = True
    ```

2.  **创建商品：**

    ```python
    @app.post("/products/")
    def create_product(product: Product):
        #  将商品信息保存到数据库 (这里仅为示例，实际应用中需要连接数据库)
        print(f"创建商品：{product}")
        return product
    ```

3.  **获取商品信息：**

    ```python
    @app.get("/products/{product_id}")
    def read_product(product_id: int):
        #  从数据库中获取商品信息 (这里仅为示例)
        product = {
            "id": product_id,
            "name": "Example Product",
            "description": "This is an example product.",
            "price": 99.99,
            "is_active": True
        }
        return product
    ```

**性能指标：**

TechEmpower 的基准测试表明，FastAPI 在 Uvicorn 下运行的性能非常出色，是 Python 框架中最快的之一。

**依赖项：**

FastAPI 依赖于 Pydantic 和 Starlette.

*   **Pydantic:**  用于数据验证和类型转换。
*   **Starlette:**  提供 Web 框架的核心功能。

**总结：**

FastAPI 是一个强大、易用且高性能的 Python Web 框架，非常适合用于构建现代化的 API 接口。 它的简洁性、高效性和强大的功能，能够帮助开发者快速构建高质量的应用程序。